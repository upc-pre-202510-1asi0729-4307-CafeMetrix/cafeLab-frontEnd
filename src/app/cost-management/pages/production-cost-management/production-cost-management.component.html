<app-toolbar></app-toolbar>

<div class="main-container">
  <!-- Success Message -->
  <div *ngIf="isSuccess" class="success-screen">
    <div class="success-message">
      <h2>¡Registro guardado exitosamente!</h2>
      <p class="registration-code">Código de registro: {{ registrationCode }}</p>
    </div>

    <div class="success-content">
      <!-- Left Column - Metrics -->
      <div class="metrics-column">
        <mat-card class="metric-card">
          <mat-card-content>
            <h3>Costo por Kilogramo</h3>
            <div class="metric-value">S/. {{ costPerKg | number:'1.2-2' }}</div>
          </mat-card-content>
        </mat-card>

        <mat-card class="metric-card">
          <mat-card-content>
            <h3>Margen Potencial</h3>
            <div class="metric-value">{{ potentialMargin | number:'1.0-1' }}%</div>
          </mat-card-content>
        </mat-card>

        <mat-card class="metric-card">
          <mat-card-content>
            <h3>Precio Sugerido</h3>
            <div class="metric-value">S/. {{ suggestedPrice | number:'1.2-2' }}/kg</div>
          </mat-card-content>
        </mat-card>
      </div>

      <!-- Right Column - Recommendations -->
      <div class="recommendations-column">
        <mat-card class="recommendations-card">
          <mat-card-header>
            <mat-card-title>Recomendaciones</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="recommendations-list">
              <div *ngFor="let rec of recommendations" class="recommendation-item" [ngClass]="rec.type">
                <span class="check-icon">✓</span>
                {{ rec.message }}
              </div>
            </div>
          </mat-card-content>
        </mat-card>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="button-container">
      <button mat-raised-button class="action-button" (click)="onExit()">
        Salir
      </button>
      <button mat-raised-button class="action-button" (click)="onPrint()">
        Imprimir reporte
      </button>
    </div>
  </div>

  <!-- Stepper Content (shown when not success) -->
  <div *ngIf="!isSuccess">
    <!-- Breadcrumb -->
    <div class="breadcrumb">
      <span>Inicio > Registro de costos por lote</span>
    </div>

    <!-- Stepper -->
    <mat-stepper (selectionChange)="currentStep = $event.selectedIndex">
      <mat-step [stepControl]="firstFormGroup">
        <ng-template matStepLabel>Selección de lote</ng-template>
        <div class="step-content">
          <!-- Progress Bar -->
          <mat-progress-bar mode="determinate" [value]="progressValue"></mat-progress-bar>

          <h2>Selección del lote</h2>
          <form [formGroup]="firstFormGroup">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Seleccione un lote</mat-label>
              <mat-select formControlName="selectedLot">
                <mat-option value="lot1">Lote 1</mat-option>
                <mat-option value="lot2">Lote 2</mat-option>
                <mat-option value="lot3">Lote 3</mat-option>
              </mat-select>
              <mat-error *ngIf="firstFormGroup.get('selectedLot')?.invalid">
                {{ getErrorMessage(firstFormGroup.get('selectedLot'), 'Lote') }}
              </mat-error>
            </mat-form-field>
          </form>

          <!-- Buttons -->
          <div class="button-container">
            <button mat-raised-button class="action-button" (click)="onCancel()">
              Cancelar
            </button>
            <button mat-raised-button class="action-button"
                    [disabled]="!firstFormGroup.valid"
                    matStepperNext>
              Continuar
            </button>
          </div>
        </div>
      </mat-step>

      <mat-step [stepControl]="directCostsForm">
        <ng-template matStepLabel>Costos directos</ng-template>
        <div class="step-content">
          <!-- Progress Bar -->
          <mat-progress-bar mode="determinate" [value]="progressValue"></mat-progress-bar>

          <div class="cards-container">
            <div class="cards-row">
              <!-- Raw Materials Card -->
              <mat-card class="cost-card">
                <mat-card-header>
                  <mat-card-title>Costos de materia prima</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form [formGroup]="directCostsForm">
                    <div class="inputs-row" formGroupName="rawMaterials">
                      <mat-form-field appearance="outline">
                        <mat-label>Costo por kg de café verde</mat-label>
                        <input matInput type="number" formControlName="costPerKg">
                        <mat-error *ngIf="directCostsForm.get('rawMaterials.costPerKg')?.invalid">
                          {{ getErrorMessage(directCostsForm.get('rawMaterials.costPerKg'), 'Costo por kg') }}
                        </mat-error>
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Cantidad de café verde (kg)</mat-label>
                        <input matInput type="number" formControlName="quantity">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Total</mat-label>
                        <input matInput [value]="rawMaterialTotal" readonly>
                      </mat-form-field>
                    </div>
                  </form>
                </mat-card-content>
              </mat-card>

              <!-- Labor Card -->
              <mat-card class="cost-card">
                <mat-card-header>
                  <mat-card-title>Costos de mano de obra directa</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form [formGroup]="directCostsForm">
                    <div class="inputs-row" formGroupName="labor">
                      <mat-form-field appearance="outline">
                        <mat-label>Horas trabajadas</mat-label>
                        <input matInput type="number" formControlName="hoursWorked">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Costo por hora</mat-label>
                        <input matInput type="number" formControlName="costPerHour">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Número de trabajadores</mat-label>
                        <input matInput type="number" formControlName="numberOfWorkers">
                      </mat-form-field>
                    </div>
                    <div class="total-row">
                      <mat-form-field appearance="outline">
                        <mat-label>Total</mat-label>
                        <input matInput [value]="laborTotal" readonly>
                      </mat-form-field>
                    </div>
                  </form>
                </mat-card-content>
              </mat-card>
            </div>
          </div>

          <!-- Buttons -->
          <div class="button-container">
            <button mat-raised-button class="action-button" matStepperPrevious>
              Anterior
            </button>
            <button mat-raised-button class="action-button"
                    [disabled]="!directCostsForm.valid"
                    matStepperNext>
              Continuar
            </button>
          </div>
        </div>
      </mat-step>

      <mat-step [stepControl]="indirectCostsForm">
        <ng-template matStepLabel>Costos indirectos</ng-template>
        <div class="step-content">
          <!-- Progress Bar -->
          <mat-progress-bar mode="determinate" [value]="progressValue"></mat-progress-bar>

          <div class="cards-container indirect-costs">
            <div class="cards-row">
              <!-- Transport Card -->
              <mat-card class="cost-card">
                <mat-card-header>
                  <mat-card-title>Costos de transporte</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form [formGroup]="indirectCostsForm">
                    <div class="inputs-row" formGroupName="transport">
                      <mat-form-field appearance="outline">
                        <mat-label>Costo por kg de café verde</mat-label>
                        <input matInput type="number" formControlName="costPerKg">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Cantidad de café verde (kg)</mat-label>
                        <input matInput type="number" formControlName="quantity">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Costo total de materia prima</mat-label>
                        <input matInput [value]="transportTotal" readonly>
                      </mat-form-field>
                    </div>
                  </form>
                </mat-card-content>
              </mat-card>

              <!-- Storage Card -->
              <mat-card class="cost-card">
                <mat-card-header>
                  <mat-card-title>Costos de almacenamiento</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form [formGroup]="indirectCostsForm">
                    <div class="inputs-row" formGroupName="storage">
                      <mat-form-field appearance="outline">
                        <mat-label>Días en almacén</mat-label>
                        <input matInput type="number" formControlName="daysInStorage">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Costo diario de almacenamiento</mat-label>
                        <input matInput type="number" formControlName="dailyCost">
                      </mat-form-field>

                      <mat-form-field appearance="outline">
                        <mat-label>Costo total de almacenamiento</mat-label>
                        <input matInput [value]="storageTotal" readonly>
                      </mat-form-field>
                    </div>
                  </form>
                </mat-card-content>
              </mat-card>
            </div>

            <div class="cards-row">
              <!-- Processing Card -->
              <mat-card class="cost-card">
                <mat-card-header>
                  <mat-card-title>Costos de procesamiento</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form [formGroup]="indirectCostsForm">
                    <div formGroupName="processing">
                      <div class="inputs-grid">
                        <mat-form-field appearance="outline">
                          <mat-label>Energía eléctrica</mat-label>
                          <input matInput type="number" formControlName="electricity">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Mantenimiento de maquinaria</mat-label>
                          <input matInput type="number" formControlName="maintenance">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Insumos de procesamiento</mat-label>
                          <input matInput type="number" formControlName="supplies">
                        </mat-form-field>
                      </div>

                      <div class="inputs-grid-bottom">
                        <mat-form-field appearance="outline">
                          <mat-label>Agua utilizada</mat-label>
                          <input matInput type="number" formControlName="water">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Depreciación de equipo</mat-label>
                          <input matInput type="number" formControlName="depreciation">
                        </mat-form-field>
                      </div>

                      <div class="inputs-grid-single">
                        <mat-form-field appearance="outline">
                          <mat-label>Total</mat-label>
                          <input matInput [value]="processingTotal" readonly>
                        </mat-form-field>
                      </div>
                    </div>
                  </form>
                </mat-card-content>
              </mat-card>

              <!-- Others Card -->
              <mat-card class="cost-card">
                <mat-card-header>
                  <mat-card-title>Otros costos indirectos</mat-card-title>
                </mat-card-header>
                <mat-card-content>
                  <form [formGroup]="indirectCostsForm">
                    <div formGroupName="others">
                      <div class="inputs-grid">
                        <mat-form-field appearance="outline">
                          <mat-label>Control de calidad</mat-label>
                          <input matInput type="number" formControlName="qualityControl">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Certificaciones</mat-label>
                          <input matInput type="number" formControlName="certifications">
                        </mat-form-field>

                        <mat-form-field appearance="outline">
                          <mat-label>Seguros</mat-label>
                          <input matInput type="number" formControlName="insurance">
                        </mat-form-field>
                      </div>

                      <div class="inputs-grid-single">
                        <mat-form-field appearance="outline">
                          <mat-label>Gastos administrativos</mat-label>
                          <input matInput type="number" formControlName="administrative">
                        </mat-form-field>
                      </div>

                      <div class="inputs-grid-single">
                        <mat-form-field appearance="outline">
                          <mat-label>Total</mat-label>
                          <input matInput [value]="othersTotal" readonly>
                        </mat-form-field>
                      </div>
                    </div>
                  </form>
                </mat-card-content>
              </mat-card>
            </div>
          </div>

          <!-- Buttons -->
          <div class="button-container">
            <button mat-raised-button class="action-button" matStepperPrevious>
              Anterior
            </button>
            <button mat-raised-button class="action-button"
                    [disabled]="!indirectCostsForm.valid"
                    matStepperNext>
              Continuar
            </button>
          </div>
        </div>
      </mat-step>

      <mat-step>
        <ng-template matStepLabel>Resumen</ng-template>
        <div class="step-content">
          <!-- Progress Bar -->
          <mat-progress-bar mode="determinate" [value]="progressValue"></mat-progress-bar>

          <div class="summary-container">
            <div class="summary-layout">
              <!-- Cost Categories Table -->
              <div class="cost-table">
                <table>
                  <thead>
                    <tr>
                      <th>Categoría de Costo</th>
                      <th>Monto</th>
                      <th>% del Total</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr *ngFor="let cost of getCostCategories()">
                      <td>{{ cost.category }}</td>
                      <td>S/. {{ cost.amount | number:'1.2-2' }}</td>
                      <td>{{ cost.percentage | number:'1.0-1' }}%</td>
                    </tr>
                    <tr class="total-row">
                      <td>TOTAL</td>
                      <td>S/. {{ grandTotal | number:'1.2-2' }}</td>
                      <td>100%</td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <!-- Cost Cards -->
              <div class="cost-cards">
                <mat-card class="summary-card">
                  <mat-card-content>
                    <h3>Costo Total del Lote</h3>
                    <div class="cost-amount">S/. {{ grandTotal | number:'1.2-2' }}</div>
                  </mat-card-content>
                </mat-card>

                <mat-card class="summary-card">
                  <mat-card-content>
                    <h3>Costo por Kilogramo</h3>
                    <div class="cost-amount">S/. {{ costPerKg | number:'1.2-2' }}</div>
                  </mat-card-content>
                </mat-card>

                <mat-card class="summary-card">
                  <mat-card-content>
                    <h3>Costo por Taza</h3>
                    <div class="cost-amount">S/. {{ costPerCup | number:'1.2-2' }}</div>
                  </mat-card-content>
                </mat-card>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="button-container">
              <button mat-raised-button class="action-button" matStepperPrevious>
                Anterior
              </button>
              <button mat-raised-button class="action-button" (click)="onSaveAsDraft()">
                Guardar Borrador
              </button>
              <button mat-raised-button class="action-button"
                      [disabled]="isSubmitting"
                      (click)="onSubmit()">
                {{ isSubmitting ? 'Enviando...' : 'Guardar registro' }}
              </button>
            </div>
          </div>
        </div>
      </mat-step>
    </mat-stepper>
  </div>
</div>
